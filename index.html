<!DOCTYPE html>  <html> <head>   <title>uso_meet_markdown.user.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               uso_meet_markdown.user.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <p>USO, meet Markdown. One day Userscripts.org used plain HTML for writing comments and guides,
little did he know about a young lass that called herself Markdown.
Userscripts.org fell madly in love.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>==UserScript== <br />
@name           USO, meet Markdown. <br />
@namespace      <a href='http://userscripts.org/users/tim'>http://userscripts.org/users/tim</a> <br />
@description    Markdown gets married to Userscript.org <br />
@include        <a href='http://userscripts.org/topics/*'>http://userscripts.org/topics/*</a> <br />
@require        <a href='http://userscripts.org/scripts/source/70908.user.js'>http://userscripts.org/scripts/source/70908.user.js</a> <br />
==/UserScript==</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>Anonymous function wrapper, so we don't step on anyones toes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <h3>Post class</h3>

<p>This class represents a post on Userscripts.org, usually found in a topic</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Post</span>
    <span class="nv">constructor: </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="err">@</span><span class="nv">element: </span><span class="nx">element</span>

    <span class="nv">element: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <h3>Guide class</h3>

<p>Represents a guide on Userscripts.org</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Guide</span>
    <span class="nv">constructor: </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <h3>Editor class</h3>

<p>Represents the current editor in the page</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Editor</span>
    <span class="nv">constructor: </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="err">@</span><span class="nv">element: </span><span class="nx">element</span>

      <span class="k">if</span> <span class="s1">&#39;DIV&#39;</span> <span class="o">is</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span>
        <span class="err">@</span><span class="nx">initFromReply</span><span class="p">()</span>

    <span class="nv">element: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>Here we modify the reply box, and over-ride a function on the USO
page that gets called on a edit operation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initFromReply: </span><span class="o">-&gt;</span>
      <span class="nv">oldSetReplyId: </span><span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">EditForm</span><span class="p">.</span><span class="nx">setReplyId</span>

      <span class="nv">self: </span><span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>Practically this is the 'onPostEdit' listener</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">unsafeWindow.EditForm.setReplyId: </span><span class="o">-&gt;</span>
        <span class="nx">oldSetReplyId</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">EditForm</span><span class="p">,</span> <span class="nx">arguments</span>

        <span class="nv">element: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;edit&#39;</span>
        <span class="err">@</span><span class="nx">modifyEntryContainer</span> <span class="nx">element</span>

        <span class="nv">textarea: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;edit_post_body&#39;</span>
        <span class="nv">textarea.disabled: </span><span class="kc">true</span>

        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(((</span><span class="nx">textarea</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">test</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="p">(</span><span class="nx">markdown</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="nx">textarea</span> <span class="o">and</span> <span class="nx">element</span>
              <span class="nv">textarea.value: </span><span class="nx">markdown</span>
              <span class="nv">textarea.disabled: </span><span class="kc">false</span>
              <span class="nv">form: </span><span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
              <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nv">type: </span><span class="s1">&#39;button&#39;</span>
              <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="o">-&gt;</span>
                <span class="nv">textarea.value: </span><span class="nx">markdownToHtml</span><span class="p">.</span><span class="nx">call</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span>
                <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">).</span>
                                      <span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                                      <span class="nx">submit</span><span class="p">()),</span> <span class="kc">false</span><span class="p">)</span>
          <span class="nv">textarea.value: </span><span class="s1">&#39;Converting to markdown...&#39;</span>
        <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">textarea</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">addShortcuts</span> <span class="nx">textarea</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <p>For the normal reply box</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="err">@</span><span class="nx">modifyEntryContainer</span> <span class="err">@</span><span class="nx">element</span>

      <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="err">@</span><span class="nx">element</span>

      <span class="nv">form: </span><span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">textarea: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;post_body&#39;</span>

      <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nv">type: </span><span class="s1">&#39;button&#39;</span>
      <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="o">-&gt;</span>
        <span class="nv">textarea.value: </span><span class="nx">markdownToHtml</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span>
        <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;reply&#39;</span><span class="p">).</span>
                              <span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                              <span class="nx">submit</span><span class="p">()),</span> <span class="kc">false</span><span class="p">)</span>
      <span class="err">@</span><span class="nx">addShortcuts</span> <span class="nx">textarea</span>

    <span class="nv">modifyEntryContainer: </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;h5&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span>
              <span class="nv">textContent: </span><span class="s1">&#39;Use Markdown to format your reply.&#39;</span>

    <span class="nv">test: </span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">htmlToMarkdown</span> <span class="nx">html</span><span class="p">,</span> <span class="nx">callback</span>

    <span class="nv">addShortcuts: </span><span class="p">(</span><span class="nx">textarea</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">textarea</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <h3>Page class</h3>

<p>Represents a page on USO, depending on the URI. It will add all
the necessary listeners, insert all the elements, construct all the posts,
the guide if necessary, and generally all the other stuff I missed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Page</span>
    <span class="nv">init: </span><span class="o">-&gt;</span>
      <span class="nv">path: </span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span>

      <span class="k">if</span> <span class="mi">0</span> <span class="o">is</span> <span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39;/topics&#39;</span>
        <span class="err">@</span><span class="nx">initFromTopic</span><span class="p">()</span>

    <span class="nv">comments: </span><span class="p">[]</span>
    <span class="nv">editor: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <p>Set-up page from a standard topic.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initFromTopic: </span><span class="o">-&gt;</span>
      <span class="nv">postElements: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                             <span class="nx">getElementsByTagName</span> <span class="s1">&#39;tr&#39;</span>

      <span class="err">@</span><span class="nv">editor: </span><span class="k">new</span> <span class="nx">Editor</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;reply&#39;</span><span class="p">)</span>

      <span class="k">for</span> <span class="nx">post</span> <span class="k">in</span> <span class="nx">postElements</span>
        <span class="err">@</span><span class="nx">comments</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Post</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <h3>Parsing functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <p>A instance of showdown</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">showdown: </span><span class="k">new</span> <span class="nx">Showdown</span><span class="p">.</span><span class="nx">converter</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <p>Takes a string of html, and parses it to markdown using
<a href='http://github.com/Tim-Smart/usotools-markdownify'>http://github.com/Tim-Smart/usotools-markdownify</a></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">htmlToMarkdown: </span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">GM_xmlhttpRequest</span> <span class="p">{</span>
      <span class="nv">method: </span><span class="s1">&#39;POST&#39;</span>
      <span class="nv">headers: </span><span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
      <span class="p">}</span>
      <span class="nv">url: </span><span class="s1">&#39;http://www.usotools.co.cc/markdown/&#39;</span>
      <span class="nv">data: </span><span class="s1">&#39;html=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span> <span class="nx">html</span>
      <span class="nv">onload: </span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nv">textarea: </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;textarea&#39;</span>
        <span class="nv">textarea.innerHTML: </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span>
        <span class="nx">callback</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span>
        <span class="nv">textarea: </span><span class="kc">null</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-15">#</a>               </div>               <p>Takes a string of markdown, and parses it to html</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">markdownToHtml: </span><span class="p">(</span><span class="nx">markdown</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">showdown</span><span class="p">.</span><span class="nx">makeHtml</span> <span class="nx">markdown</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-16">#</a>               </div>               <h3>Helper functions</h3>

<p>A few helper functions that break us away from browser-incompatibility
and RSI.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-17">#</a>               </div>               <p>GM_addStyle, a drop in replacement for the original GM_addStyle
when it doesn't exist</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="s1">&#39;function&#39;</span> <span class="o">isnt</span> <span class="k">typeof</span> <span class="nx">GM_addStyle</span>
    <span class="nv">GM_addStyle: </span><span class="p">(</span><span class="nx">css</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nv">head: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">style: </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;style&#39;</span>
      <span class="nv">style.textContent: </span><span class="nx">css</span>
      <span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">style</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-18">#</a>               </div>               <p>Make sure unsafeWindow is all g</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="o">`</span><span class="nx">unsafeWindow</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">unsafeWindow</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="nx">unsafeWindow</span><span class="o">`</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-19">#</a>               </div>               <p>Finally start setting up page</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">new</span> <span class="nx">Page</span><span class="p">().</span><span class="nx">init</span><span class="p">();</span>
<span class="p">)()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 