<!DOCTYPE html>  <html> <head>   <title>uso_meet_markdown.user.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               uso_meet_markdown.user.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <p>USO, meet Markdown. One day Userscripts.org used plain HTML for writing comments and guides,
little did he know about a young lass that called herself Markdown.
Userscripts.org fell madly in love.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>==UserScript== <br />
@name           USO, meet Markdown. <br />
@namespace      <a href='http://userscripts.org/users/tim'>http://userscripts.org/users/tim</a> <br />
@description    Markdown gets married to Userscript.org <br />
@include        <a href='http://userscripts.org/topics/*'>http://userscripts.org/topics/*</a> <br />
@require        <a href='http://userscripts.org/scripts/source/70908.user.js'>http://userscripts.org/scripts/source/70908.user.js</a> <br />
@require        <a href='http://updater.usotools.co.cc/70901.js'>http://updater.usotools.co.cc/70901.js</a> <br />
==/UserScript==</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>Some ideas in this script originated from SizzleMcTwizzle's comment fix script: 
<a href='http://userscripts.org/scripts/show/24464'>http://userscripts.org/scripts/show/24464</a></p>

<p>Kudos to him!</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>Anonymous function wrapper, so we don't step on anyones toes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <h3>Post class</h3>

<p>This class represents a post on Userscripts.org, usually found in a topic</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Post</span>
    <span class="nv">constructor: </span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="err">@</span><span class="nv">page: </span><span class="nx">page</span>
      <span class="err">@</span><span class="nv">element: </span><span class="nx">element</span>

      <span class="k">if</span> <span class="s1">&#39;TR&#39;</span> <span class="o">is</span> <span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span>
        <span class="err">@</span><span class="nx">initFromTopic</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="s1">&#39;DIV&#39;</span> <span class="o">is</span> <span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span>
        <span class="err">@</span><span class="nx">initFromGuide</span><span class="p">()</span>

    <span class="nv">element: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <p>We are currently in a guide, attach listeners, grab post info etc
and populate the Post instance with data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initFromTopic: </span><span class="o">-&gt;</span>
      <span class="nv">authorCont: </span><span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">nameLink: </span><span class="nx">authorCont</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;fn&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                           <span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">linkCont: </span><span class="nx">authorCont</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">if</span> <span class="o">not</span> <span class="nx">linkCont</span>
        <span class="nv">linkCont: </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;p&#39;</span>
        <span class="nx">authorCont</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">linkCont</span><span class="p">,</span>
                                <span class="nx">authorCont</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;useragent&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

      <span class="err">@</span><span class="nv">id: </span><span class="sr">/\d+$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="err">@</span><span class="nv">userId: </span><span class="nx">nameLink</span><span class="p">.</span><span class="nx">getAttribute</span> <span class="s1">&#39;user_id&#39;</span>
      <span class="err">@</span><span class="nv">userName: </span><span class="nx">nameLink</span><span class="p">.</span><span class="nx">textContent</span>
      <span class="err">@</span><span class="nv">userHref: </span><span class="nx">nameLink</span><span class="p">.</span><span class="nx">href</span>
      <span class="err">@</span><span class="nv">body: </span><span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                      <span class="nx">innerHTML</span>

      <span class="err">@</span><span class="nv">belongsToUser: </span><span class="k">if</span> <span class="nx">authorCont</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kc">true</span>
      <span class="k">else</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>Insert the quote link</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="err">@</span><span class="nx">insertUtility</span> <span class="s1">&#39;Quote&#39;</span><span class="p">,</span> <span class="nx">linkCont</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="err">@</span><span class="nx">quote</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>Insert the Report link, depending if the post
belongs to the current user or not</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="err">@</span><span class="nx">belongsToUser</span>
        <span class="err">@</span><span class="nx">insertUtility</span> <span class="s1">&#39;Report&#39;</span><span class="p">,</span> <span class="nx">linkCont</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="err">@</span><span class="nx">report</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <p>Shortcut for inserting a utility link into the post
author section. cont is an optional container, to save
looking for it again</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">insertUtility: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cont</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="s1">&#39;function&#39;</span> <span class="o">is</span> <span class="k">typeof</span> <span class="nx">cont</span>
        <span class="nv">callback: </span><span class="nx">cont</span>
        <span class="nv">cont: </span><span class="kc">null</span>

      <span class="nv">span: </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;span&#39;</span>
      <span class="nv">span.style.display: </span><span class="s1">&#39;block&#39;</span>
      <span class="nv">span.className: </span><span class="s1">&#39;edit&#39;</span>

      <span class="nv">link: </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;a&#39;</span>
      <span class="nv">link.style.fontSize: </span><span class="s1">&#39;12px&#39;</span>
      <span class="nv">link.textContent: </span><span class="nx">name</span>
      <span class="nv">link.href: </span><span class="s1">&#39;#&#39;</span>
      <span class="nv">link.className: </span><span class="s1">&#39;utility&#39;</span>
      <span class="nx">link</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">((</span><span class="nx">event</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>
      <span class="p">),</span> <span class="kc">false</span><span class="p">)</span>

      <span class="nx">span</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">link</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">cont</span>
        <span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                 <span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                 <span class="nx">appendChild</span> <span class="nx">span</span>
      <span class="k">else</span>
        <span class="nx">cont</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">span</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>This post function takes either a selection, or the entire post body,
then passes it to the editor 'insertQuote' function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">quote: </span><span class="o">-&gt;</span>
      <span class="nv">selection: </span><span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">()</span>
      <span class="nv">html: </span><span class="s1">&#39;&#39;</span>
      <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="o">is</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nv">html: </span><span class="err">@</span><span class="nx">body</span>
      <span class="k">else</span>
        <span class="nv">range: </span><span class="nx">selection</span><span class="p">.</span><span class="nx">getRangeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nv">element: </span><span class="nx">range</span><span class="p">.</span><span class="nx">commonAncestorContainer</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span>
          <span class="k">if</span> <span class="s1">&#39;TD&#39;</span> <span class="o">is</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">and</span> <span class="mi">0</span> <span class="o">is</span> <span class="nx">element</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39;post-body-&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;post-body-&#39;</span> <span class="o">+</span> <span class="err">@</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">element</span><span class="p">.</span><span class="nx">id</span>
              <span class="nv">properSelection: </span><span class="kc">true</span>
            <span class="k">break</span>
          <span class="nv">element: </span><span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span>
        <span class="k">if</span> <span class="nx">properSelection</span>
          <span class="nv">range: </span><span class="nx">range</span><span class="p">.</span><span class="nx">cloneContents</span><span class="p">()</span>
          <span class="nv">holder: </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;div&#39;</span>
          <span class="nx">holder</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">range</span>
          <span class="nv">html: </span><span class="nx">holder</span><span class="p">.</span><span class="nx">innerHTML</span>
          <span class="nv">holder: range: </span><span class="kc">null</span>
        <span class="k">else</span> <span class="nv">html: </span><span class="err">@</span><span class="nx">body</span>
      <span class="nx">page</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">insertQuote</span> <span class="nx">html</span><span class="p">,</span> <span class="err">@</span><span class="nx">userName</span><span class="p">,</span> <span class="err">@</span><span class="nx">userId</span><span class="p">,</span> <span class="err">@</span><span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <p>This function will report the post as spam, to the USO spam topic</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">report: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nv">comments: </span><span class="nx">prompt</span> <span class="s1">&#39;Do you want to mention any specific details about the offender?&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;This post contained spam.&#39;</span>
      <span class="nv">reportHtml: </span><span class="s2">&quot;&lt;p&gt;I believe the user &lt;a href=&#39;/users/$@userId&#39;&gt;$@userName&lt;/a&gt; has</span>
<span class="s2">                  made an inappropiate &lt;a href=&#39;${location.pathname + location.search}#post-body-$@id&#39;&gt;post&lt;/a&gt;</span>
<span class="s2">                  in &lt;a href=&#39;$location.pathname&#39;&gt;this topic&lt;/a&gt;.&lt;/p&gt;&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">comments</span>
        <span class="k">return</span>
      <span class="k">else</span> <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="o">isnt</span> <span class="nx">comments</span>
        <span class="nx">reportHtml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;p&gt;$comments&lt;/p&gt;&quot;</span>

      <span class="nx">GM_xmlhttpRequest</span> <span class="p">{</span>
        <span class="nv">url: </span><span class="s2">&quot;http://$location.host/topics/9/posts&quot;</span>
        <span class="nv">method: </span><span class="s1">&#39;POST&#39;</span>
        <span class="nv">headers: </span><span class="p">{</span>
          <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
        <span class="p">}</span>
        <span class="nv">data: </span><span class="s2">&quot;authenticity_token=${encodeURIComponent unsafeWindow.auth_token}&amp;post%5Bbody%5D=&quot;</span> <span class="o">+</span>
              <span class="s2">&quot;${encodeURIComponent reportHtml}&amp;commit=Post+reply&quot;</span>
        <span class="nv">onload: </span><span class="o">-&gt;</span>
          <span class="nv">event.target.textContent: </span><span class="s1">&#39;Reported!&#39;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <h3>Guide class</h3>

<p>Represents a guide on Userscripts.org</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Guide</span>
    <span class="nv">constructor: </span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="err">@</span><span class="nv">page: </span><span class="nx">page</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <h3>Editor class</h3>

<p>Represents the current editor in the page</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Editor</span>
    <span class="nv">constructor: </span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="err">@</span><span class="nv">page: </span><span class="nx">page</span>
      <span class="err">@</span><span class="nv">element: </span><span class="nx">element</span>

      <span class="k">if</span> <span class="s1">&#39;DIV&#39;</span> <span class="o">is</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span>
        <span class="err">@</span><span class="nx">initFromReply</span><span class="p">()</span>

    <span class="nv">element: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <p>Here we modify the reply box, and over-ride a function on the USO
page that gets called on a edit operation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initFromReply: </span><span class="o">-&gt;</span>
      <span class="nv">oldSetReplyId: </span><span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">EditForm</span><span class="p">.</span><span class="nx">setReplyId</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-15">#</a>               </div>               <p>Practically this is the 'onPostEdit' listener</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">unsafeWindow.EditForm.setReplyId: </span><span class="o">=&gt;</span>
        <span class="nx">oldSetReplyId</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">EditForm</span><span class="p">,</span> <span class="nx">arguments</span>

        <span class="err">@</span><span class="nv">element: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;edit&#39;</span>
        <span class="err">@</span><span class="nx">modifyEntryContainer</span> <span class="err">@</span><span class="nx">element</span>

        <span class="err">@</span><span class="nv">textarea: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;edit_post_body&#39;</span>
        <span class="err">@</span><span class="nv">textarea.disabled: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-16">#</a>               </div>               <p>Pop back into the sandbox scope, so the leak check
doesn't throw any access violation errors</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">((</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-17">#</a>               </div>               <p>Convert the HTML to Markdown</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">htmlToMarkdown</span> <span class="err">@</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="p">(</span><span class="nx">markdown</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="err">@</span><span class="nx">textarea</span> <span class="o">and</span> <span class="err">@</span><span class="nx">element</span>
              <span class="err">@</span><span class="nv">textarea.value: </span><span class="nx">markdown</span>
              <span class="err">@</span><span class="nv">textarea.disabled: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-18">#</a>               </div>               <p>Modify the submit button to convert the textarea
content before sending it off to USO</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">form: </span><span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nv">type: </span><span class="s1">&#39;button&#39;</span>
          <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="o">=&gt;</span>
            <span class="err">@</span><span class="nv">textarea.value: </span><span class="nx">markdownToHtml</span> <span class="err">@</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span>
            <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">).</span>
                                  <span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                                  <span class="nx">submit</span><span class="p">()</span>
          <span class="p">),</span> <span class="kc">false</span><span class="p">)</span>
          <span class="err">@</span><span class="nv">textarea.value: </span><span class="s1">&#39;Converting to markdown...&#39;</span>
        <span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="err">@</span><span class="nx">addShortcuts</span> <span class="err">@</span><span class="nx">textarea</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-19">#</a>               </div>               <p>For the normal reply box</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="err">@</span><span class="nx">modifyEntryContainer</span> <span class="err">@</span><span class="nx">element</span>

      <span class="nv">form: </span><span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">textarea: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;post_body&#39;</span>

      <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nv">type: </span><span class="s1">&#39;button&#39;</span>
      <span class="nx">form</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="o">-&gt;</span>
        <span class="nv">textarea.value: </span><span class="nx">markdownToHtml</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span>
        <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;reply&#39;</span><span class="p">).</span>
                              <span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                              <span class="nx">submit</span><span class="p">()</span>
      <span class="p">),</span> <span class="kc">false</span><span class="p">)</span>
      <span class="err">@</span><span class="nx">addShortcuts</span> <span class="nx">textarea</span>

      <span class="nv">oldReplyInit: </span><span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">ReplyForm</span><span class="p">.</span><span class="nx">init</span>
      <span class="nv">unsafeWindow.ReplyForm.init: </span><span class="o">=&gt;</span>
        <span class="nx">oldReplyInit</span><span class="p">.</span><span class="nx">call</span> <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">ReplyForm</span>
        <span class="err">@</span><span class="nv">element: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;reply&#39;</span>
        <span class="err">@</span><span class="nv">textarea: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;post_body&#39;</span>

      <span class="err">@</span><span class="nv">element: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-20">#</a>               </div>               <p>This function takes a reply 'containter' div, and chops and changes
it to our liking</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">modifyEntryContainer: </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;h5&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span>
              <span class="nv">textContent: </span><span class="s1">&#39;Use Markdown to format your reply.&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-21">#</a>               </div>               <p>This function takes html, the User-Name, a User ID and a post ID,
converts it to markdown, then inserts the
resulting quote into the current textarea</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">insertQuote: </span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">postId</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="err">@</span><span class="nx">ensureElement</span><span class="p">()</span>
        <span class="nv">previous: </span><span class="nx">markdownToHtml</span> <span class="err">@</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span>

        <span class="nv">modify: </span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="o">-&gt;</span>
          <span class="nx">previous</span> <span class="o">+</span> <span class="nx">html</span>

      <span class="err">@</span><span class="nv">textarea.disabled: </span><span class="kc">true</span>
      <span class="err">@</span><span class="nv">textarea.value: </span><span class="s1">&#39;Converting quote to Markdown...&#39;</span>

      <span class="nv">html: </span><span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;!--.+--&gt;/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span>
      <span class="nv">html: </span><span class="s2">&quot;&lt;blockquote&gt;&lt;strong&gt;&lt;a href=&#39;/users/$userId&#39;&gt;$username&lt;/a&gt;&lt;/strong&gt;&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;&amp;nbsp;&lt;a href=&#39;#posts-$postId&#39;&gt;wrote&lt;/a&gt;:&lt;br /&gt;$html&lt;/blockquote&gt;&quot;</span>

      <span class="nv">html: </span><span class="nx">modify</span> <span class="nx">html</span> <span class="k">if</span> <span class="nx">modify</span>

      <span class="nx">htmlToMarkdown</span> <span class="nx">html</span><span class="p">,</span> <span class="p">(</span><span class="nx">markdown</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="err">@</span><span class="nv">textarea.value: </span><span class="nx">markdown</span>
        <span class="err">@</span><span class="nv">textarea.disabled: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-22">#</a>               </div>               <p>This is used by the insertQuote function to see whether we are currently
in a reply or not. If we are not in a reply, it will open a reply box. If
we are in a edit or reply, it just returns true</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ensureElement: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="err">@</span><span class="nx">element</span>
        <span class="err">@</span><span class="nx">openReply</span><span class="p">()</span>
        <span class="kc">false</span>
      <span class="k">else</span> <span class="k">if</span> <span class="s1">&#39;none&#39;</span> <span class="o">is</span> <span class="err">@</span><span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>
        <span class="err">@</span><span class="nx">openReply</span><span class="p">()</span>
        <span class="kc">false</span>
      <span class="k">else</span>
        <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-23">#</a>               </div>               <p>Opens the reply box, simple.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">openReply: </span><span class="o">-&gt;</span>
      <span class="nx">unsafeWindow</span><span class="p">.</span><span class="nx">ReplyForm</span><span class="p">.</span><span class="nx">init</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-24">#</a>               </div>               <p>Adds the follow keyboard shortcuts</p>

<ul>
<li>Nothing yet!</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">addShortcuts: </span><span class="p">(</span><span class="nx">textarea</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-25">#</a>               </div>               <h3>Page class</h3>

<p>Represents a page on USO, depending on the URI. It will add all
the necessary listeners, insert all the elements, construct all the posts,
the guide if necessary, and generally all the other stuff I missed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">class</span> <span class="nx">Page</span>
    <span class="nv">init: </span><span class="o">-&gt;</span>
      <span class="nv">path: </span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span>

      <span class="k">if</span> <span class="mi">0</span> <span class="o">is</span> <span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39;/topics&#39;</span>
        <span class="err">@</span><span class="nx">initFromTopic</span><span class="p">()</span>

    <span class="nv">comments: </span><span class="p">[]</span>
    <span class="nv">editor: </span><span class="kc">null</span>
    <span class="nv">title: </span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-26">#</a>               </div>               <p>Set-up page from a standard topic.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initFromTopic: </span><span class="o">-&gt;</span>
      <span class="nv">postElements: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="s1">&#39;post&#39;</span>

      <span class="err">@</span><span class="nv">editor: </span><span class="k">new</span> <span class="nx">Editor</span> <span class="err">@</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s1">&#39;reply&#39;</span>

      <span class="k">for</span> <span class="nx">post</span> <span class="k">in</span> <span class="nx">postElements</span>
        <span class="err">@</span><span class="nx">comments</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Post</span> <span class="err">@</span><span class="p">,</span> <span class="nx">post</span>

      <span class="err">@</span><span class="nv">title: </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;topic-title&#39;</span><span class="p">).</span><span class="nx">firstChild</span><span class="p">.</span>
                       <span class="nx">textContent</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">replace</span> <span class="o">/</span><span class="err">\</span><span class="nx">s</span><span class="o">+</span><span class="err">/g, &#39; &#39;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-27">#</a>               </div>               <h3>Parsing functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-28">#</a>               </div>               <p>A instance of showdown</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">showdown: </span><span class="k">new</span> <span class="nx">Showdown</span><span class="p">.</span><span class="nx">converter</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-29">#</a>               </div>               <p>Takes a string of html, and parses it to markdown using
<a href='http://github.com/Tim-Smart/usotools-markdownify'>http://github.com/Tim-Smart/usotools-markdownify</a></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">htmlToMarkdown: </span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">GM_xmlhttpRequest</span> <span class="p">{</span>
      <span class="nv">method: </span><span class="s1">&#39;POST&#39;</span>
      <span class="nv">headers: </span><span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
      <span class="p">}</span>
      <span class="nv">url: </span><span class="s1">&#39;http://www.usotools.co.cc/markdown/&#39;</span>
      <span class="nv">data: </span><span class="s1">&#39;html=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span> <span class="nx">html</span>
      <span class="nv">onload: </span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nv">textarea: </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;textarea&#39;</span>
        <span class="nv">textarea.innerHTML: </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span>
        <span class="nx">callback</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span>
        <span class="nv">textarea: </span><span class="kc">null</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-30">#</a>               </div>               <p>Takes a string of markdown, and parses it to html</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">markdownToHtml: </span><span class="p">(</span><span class="nx">markdown</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">showdown</span><span class="p">.</span><span class="nx">makeHtml</span> <span class="nx">markdown</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-31">#</a>               </div>               <p>Finally start setting up page</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">page: </span><span class="k">new</span> <span class="nx">Page</span><span class="p">()</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">init</span><span class="p">()</span>
<span class="p">)()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 